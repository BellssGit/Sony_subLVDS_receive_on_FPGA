#include "imx178.h"


void Init_IMX178()
{
	  HAL_GPIO_WritePin(GPIOA, GPIO_PIN_7, GPIO_PIN_RESET);
	  HAL_Delay(100);
	  HAL_GPIO_WritePin(GPIOA, GPIO_PIN_7, GPIO_PIN_SET);
	  HAL_Delay(100);

	  // WTF IS THIS
	  IMX178_WRITE_REG(IMX178_ADDR,0x30,0x11,0x00);
	  IMX178_WRITE_REG(IMX178_ADDR,0x30,0x37,0x08);
	  IMX178_WRITE_REG(IMX178_ADDR,0x30,0x38,0x00);
	  IMX178_WRITE_REG(IMX178_ADDR,0x30,0x39,0x00);
	  IMX178_WRITE_REG(IMX178_ADDR,0x30,0xad,0x49);
	  IMX178_WRITE_REG(IMX178_ADDR,0x30,0xaf,0x54);
	  IMX178_WRITE_REG(IMX178_ADDR,0x30,0xb0,0x33);
	  IMX178_WRITE_REG(IMX178_ADDR,0x30,0xb3,0x0a);
	  IMX178_WRITE_REG(IMX178_ADDR,0x30,0xc4,0x30);

	  IMX178_WRITE_REG(IMX178_ADDR,0x31,0x03,0x03);
	  IMX178_WRITE_REG(IMX178_ADDR,0x31,0x04,0x08);
	  IMX178_WRITE_REG(IMX178_ADDR,0x31,0x07,0x10);
	  IMX178_WRITE_REG(IMX178_ADDR,0x31,0x0f,0x01);

	  IMX178_WRITE_REG(IMX178_ADDR,0x32,0xe5,0x06);
	  IMX178_WRITE_REG(IMX178_ADDR,0x32,0xe6,0x00);
	  IMX178_WRITE_REG(IMX178_ADDR,0x32,0xe7,0x1f);
	  IMX178_WRITE_REG(IMX178_ADDR,0x32,0xe8,0x00);
	  IMX178_WRITE_REG(IMX178_ADDR,0x32,0xe9,0x00);
	  IMX178_WRITE_REG(IMX178_ADDR,0x32,0xea,0x00);
	  IMX178_WRITE_REG(IMX178_ADDR,0x32,0xeb,0x00);
	  IMX178_WRITE_REG(IMX178_ADDR,0x32,0xec,0x00);
	  IMX178_WRITE_REG(IMX178_ADDR,0x32,0xed,0x00);
	  IMX178_WRITE_REG(IMX178_ADDR,0x32,0xee,0x00);
	  IMX178_WRITE_REG(IMX178_ADDR,0x32,0xf2,0x02);
	  IMX178_WRITE_REG(IMX178_ADDR,0x32,0xf4,0x00);
	  IMX178_WRITE_REG(IMX178_ADDR,0x32,0xf5,0x00);
	  IMX178_WRITE_REG(IMX178_ADDR,0x32,0xf6,0x00);
	  IMX178_WRITE_REG(IMX178_ADDR,0x32,0xf7,0x00);
	  IMX178_WRITE_REG(IMX178_ADDR,0x32,0xf8,0x00);
	  IMX178_WRITE_REG(IMX178_ADDR,0x32,0xfc,0x02);

	  IMX178_WRITE_REG(IMX178_ADDR,0x33,0x10,0x11);
	  IMX178_WRITE_REG(IMX178_ADDR,0x33,0x38,0x81);
	  IMX178_WRITE_REG(IMX178_ADDR,0x33,0x3d,0x00);
	  IMX178_WRITE_REG(IMX178_ADDR,0x33,0x62,0x00);
	  IMX178_WRITE_REG(IMX178_ADDR,0x33,0x6b,0x02);
	  IMX178_WRITE_REG(IMX178_ADDR,0x33,0x6e,0x11);
	  IMX178_WRITE_REG(IMX178_ADDR,0x33,0xb4,0xfe);
	  IMX178_WRITE_REG(IMX178_ADDR,0x33,0xb5,0x06);
	  IMX178_WRITE_REG(IMX178_ADDR,0x33,0xb9,0x00);



	  // Set the XVS and XHS output pin function as sync out
	  IMX178_WRITE_REG(IMX178_ADDR,0x30,0x5e,0x0a);
}

void Config_IMX178_Clock_432Mbps_27MHz()
{
	  //CLOCK CONFIG for 432Mbps Lane Speed using 27MHz xtal
	  IMX178_WRITE_REG(IMX178_ADDR,0x33,0xc4,0x20);
	  IMX178_WRITE_REG(IMX178_ADDR,0x33,0xc5,0x00);
}

void Config_IMX178_Clock_297Mbps_27MHz()
{
	IMX178_WRITE_REG(IMX178_ADDR,0x33,0xbe,0x21);
	IMX178_WRITE_REG(IMX178_ADDR,0x33,0xbf,0x21);
	IMX178_WRITE_REG(IMX178_ADDR,0x33,0xc0,0x2c);
	IMX178_WRITE_REG(IMX178_ADDR,0x33,0xc1,0x2c);
	IMX178_WRITE_REG(IMX178_ADDR,0x33,0xc2,0x21);
	IMX178_WRITE_REG(IMX178_ADDR,0x33,0xc3,0x2c);
	IMX178_WRITE_REG(IMX178_ADDR,0x33,0xc4,0x2c);
	IMX178_WRITE_REG(IMX178_ADDR,0x33,0xc5,0x00);
}

void Start_IMX178()
{
	IMX178_WRITE_REG(IMX178_ADDR,0x30,0x00,0x06); // turn off STANDBY
	HAL_Delay(2); // wait 2ms
	IMX178_WRITE_REG(IMX178_ADDR,0x30,0x00,0x00); // turn off STBEXPL and STBLOGIC
	HAL_Delay(20); // wait 20ms before stable
	IMX178_WRITE_REG(IMX178_ADDR,0x30,0x08,0x00); // turn on master mode
	HAL_Delay(2); // wait 2ms
}

void Config_IMX178_6_3M_12b_8ch_30fps() {
	IMX178_WRITE_REG(IMX178_ADDR,0x30,0x0e,0x00); // Set all pixel scan
	IMX178_WRITE_REG(IMX178_ADDR,0x30,0x0f,0x00); // Set normal direction and not window mode
	IMX178_WRITE_REG(IMX178_ADDR,0x30,0x66,0x06); // Some VNDMY setting

	IMX178_WRITE_REG(IMX178_ADDR,0x30,0x2e,0x00); // Set VMAX highest bit
	IMX178_WRITE_REG(IMX178_ADDR,0x30,0x2d,0x0b); // Set VMAX middle bit
	IMX178_WRITE_REG(IMX178_ADDR,0x30,0x2c,0xbb); // Set VMAX lowest bit

	IMX178_WRITE_REG(IMX178_ADDR,0x30,0x30,0x02); // Set HMAX highest bit
	IMX178_WRITE_REG(IMX178_ADDR,0x30,0x2f,0x58); // Set HMAX lowest bit

	IMX178_WRITE_REG(IMX178_ADDR,0x30,0x0d,0x05); // Set ADC mode and resolution to 12bit
	IMX178_WRITE_REG(IMX178_ADDR,0x30,0x59,0x11); // Set output width to 12b and 8ch LVDS
	IMX178_WRITE_REG(IMX178_ADDR,0x30,0x04,0x01); // Set LVDS active channel number to 8
	IMX178_WRITE_REG(IMX178_ADDR,0x31,0x01,0x30); // Set LVDS Speed to 432Mbps

	HAL_Delay(1); // wait 1ms
}

void Config_IMX178_1080P_12b_8ch_60fps() {
	IMX178_WRITE_REG(IMX178_ADDR,0x30,0x0e,0x01); // Set 1080P pixel scan
	IMX178_WRITE_REG(IMX178_ADDR,0x30,0x0f,0x00); // Set normal direction and not window mode
	IMX178_WRITE_REG(IMX178_ADDR,0x30,0x66,0x06); // Some VNDMY setting

	IMX178_WRITE_REG(IMX178_ADDR,0x30,0x2e,0x00); // Set VMAX highest bit
	IMX178_WRITE_REG(IMX178_ADDR,0x30,0x2d,0x05); // Set VMAX middle bit
	IMX178_WRITE_REG(IMX178_ADDR,0x30,0x2c,0xdc); // Set VMAX lowest bit

	IMX178_WRITE_REG(IMX178_ADDR,0x30,0x30,0x03); // Set HMAX highest bit
	IMX178_WRITE_REG(IMX178_ADDR,0x30,0x2f,0x39); // Set HMAX lowest bit

	IMX178_WRITE_REG(IMX178_ADDR,0x30,0x0d,0x05); // Set ADC mode and resolution to 12bit
	IMX178_WRITE_REG(IMX178_ADDR,0x30,0x59,0x11); // Set output width to 12b and 8ch LVDS
	IMX178_WRITE_REG(IMX178_ADDR,0x30,0x04,0x01); // Set LVDS active channel number to 8
	IMX178_WRITE_REG(IMX178_ADDR,0x31,0x01,0x31); // Set LVDS Speed to 297Mbps

}
